---
title: 'Problem Set 3: Instrumental Variables'
author: "Claire Duquennois"
date: ""
output:
  pdf_document:
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***NAME:_____JOHN MORRIS_______________________***

**Empirical Analysis using Data from Ananat (2011, AEJ:AE)**


This exercise uses data from Elizabeth Ananat's paper, "The Wrong Side(s) of the Tracks: The Causal Effects of Racial Segregation on Urban Poverty and Inequality," published in the *American Economic Journal: Applied Economics* in 2011. This paper studies how segregation has affected population characteristics and income disparity in US cities using the layout of railroad tracks as an instrumental variable. 


**Finding the data**

I have downloaded Ananat's `aej_maindata.dta` file and made it available in the RCloud assignment workspace. I downloaded this data from the AER's website which links you to the ICPSR's data repository. Anyone can sign in to get access to the replication data files. These include the typical files in a replication folder: several datasets, several .do files (which is a STATA command file), and text files with the data descriptions which tell you about the different variables included in the dataset. 


**Submission instructions:**

1) Knit your assignment in PDF.

2) **Assignment shell extra credit:** You will receive a little extra credit if your answers line up correctly with the answer positions of the template on gradescope. For this to work 

- **Work by putting your answers directly into this R markdown file that is pre-formatted for you!**

- Make sure you have ONE question and answer per page (this is how the template is structured and  allows gradescope to easily find your answers), unless the question indicated that the answer will require two pages because of large tables. 

- Your final PDF should be 24 pages. 

- You can insert needed page breaks as illustrated below

- Make sure you do not "print" the data. If you change the data, make sure you store with a structure like: newname<-modification(olddata). If you only type modification(olddata), R will display the data rather than saving your modifications


3) Upload your assignment PDF to gradescope.





\pagebreak

# Set up and opening the data

## Question: Load the have, dplyr, stargazer, lfe and ggplot2 packages and the data contained in the `aej_maindata.dta` file. Make sure it is stored as a data frame.  

**Code:**
```{r}
library(haven)
library(dplyr)
library(stargazer)
library(lfe)
library(ggplot2)
getwd()
maindata<-read_dta("aej_maindata.dta")
maindata <- as.data.frame(maindata)
```



 \pagebreak


## Question:The dataset contains many variables, some of which are not used in this exercise. Keep the following variables in the final dataset (Hint: use the `select` function in `dplyr`). 

| Name     |Description                                                             |
|----------|------------------------------------------------------------------------|
|dism1990	 |1990 dissimilarity index                                                | 
|herf      |RDI (Railroad division index)                                           |
|lenper    |Track length per square km                                              |
|povrate_w |White poverty rate 1990                                                 |
|povrate_b |Black poverty rate 1990                                                 |
|area1910  |Physical area in 1910 (1000 sq. miles)                                  |
|count1910 |Population in 1910 (1000s)                                              | 
|ethseg10  |Ethnic Dissimilariy index in 1910                                       |
|ethiso10  |Ethnic isolation index in 1910                                          |
|black1910 |Percent Black in 1910                                                   |
|passpc    |Street cars per capita 1915                                             |
|black1920 |Percent Black 1920                                                      |
|lfp1920   |Labor Force Participation 1920                                          |
|incseg    |Income segregation 1990                                                 |
|pctbk1990 |Percent Black 1990                                                      |
|manshr    |Share employed in manufacturing 1990                                    |
|pop1990   |Population in 1990                                                      |

**You can find the detailed description of each variable in the original paper. **

**Code:**
```{r}
#names(maindata)
maindata <- maindata %>% select(dism1990, herf, lenper, povrate_b, povrate_w, area1910, count1910, ethseg10, ethiso10, black1910, passpc, black1920, lfp1920, incseg, pctbk1990, manshr, pop1990)
```


\pagebreak


# Data description: 

## Question: How many observations are contained in the data. What is the level of an observation (i.e. are observations about individuals each year? individuals seen once? Counties each year? Counties seen once? States?...) ?

**Answer:**
The data contains 121 observations. 

\pagebreak

## Question: Report summary statistics of the following variables in the dataset:"dism1990", "herf", "lenper", "povrate_w", "povrate_b". Present these summary statistics in a formatted table, you can use `stargazer` or other packages.

**Code:**
```{r results='asis'}
slctdata<- maindata %>% select(dism1990, herf, lenper, povrate_w, povrate_b)
stargazer(slctdata, type = "latex", header = FALSE, title = "Basic Summary", omit.stat = c("f", "ser"))
```

\pagebreak

# Reduced Form:

## Question: We are interested in understanding how segregation affects population characteristics and income disparity in US cities. We will focus on two outcome variables: the poverty rate for blacks and whites. Regress these two outcome variables on segregation in 1990, our explanatory variable, and interpret your results. Report robust standard errors. 

Hint 1: These exact results are reported in the second row of columns 1 and 2 of table 2. 

Hint 2: Since the units of the explanatory variable are strange, it is helpful to interpret the effect in terms of standard deviations. So instead of interpreting a one unit change in `dism1990`, interpret a  one standard deviation (0.14) change in `dism1990`. 


**Code:**
```{r}
regw<- felm(data=slctdata, povrate_w ~ dism1990)
regb <- felm(data = slctdata , povrate_b ~ dism1990)
```
```{r results='asis'}
stargazer(regw, regb, type = "latex", header = F, 
          title = "Model Comparison", omit.stat= c("f", "ser"), se = list(regw$rse, regb$rse ) )
```


**Answer:**
A one standard deviation increase in dism1990 decreased povrate_w and increased povrate_b.

\pagebreak

## Question: Explain the problem with giving a causal interpretation to the estimates you just produced. Give examples of specific confounds that might make a causal interpretation of your result problematic.

**Answer:**
In order for an effect to be causal we must believe that the incidence of the explanatory variable is "as good as random". The dissimilarity index has not yet been demonstrated to meet that criteria. 
\pagebreak


# Validity of the instrument:

## Question: Estimate the following regression and interpret it's coefficients, 
$$
 dism1990_i=\beta_0+\beta_1RDI_i+\beta_2 tracklength_i+\epsilon.
$$

Hint 1: These exact results are reported in the first column of the top panel of table 1.


Hint 2: Since the units of the explanatory variable are strange, it is helpful to interpret the effect in terms of standard deviations. So instead of interpreting a one unit change in `herf`, interpret a one standard deviation (0.14) change in `herf`. 

Hint 3: Make sure you report the same type of standard errors as the author. 


**Code:**
```{r results='asis'}
reg1<- felm(data = maindata, dism1990 ~ herf+lenper)
stargazer(reg1, type = "latex", header = F, 
          title = "Regression 1", omit.stat= c("f", "ser"), se = list(reg1$rse))
```

**Answer:**
herf (RDI) has a significant and positive relationship with dism1990 (segregation). Track length also has a positive relationship with segregation. but it is not as significant. 
\pagebreak




## Question: In the context of instrumental variables, what is this regression referred to as and why is it important? 

**Answer:**
This is the "first stage" in defining an instrumental variable. It is important to verify the correlation between our explanatory variable and our potential instrument.
\pagebreak


## Question: Illustrate the relationship between the RDI and segregation graphically. 

Hint: See figure 3.

**Code:**
```{r}
graph<- ggplot(data=slctdata, aes(x=herf, y=dism1990)) + geom_smooth(method = "lm") + theme_classic() + geom_point()
graph
```

\pagebreak


## Question: Is there a concern that this might be a weak instrument? Why would this be a problem? 

Hint: The number you want to look at has already been calculated when you ran the regression and is contained in that regression object. You can pull stuff out of a regression summary with code in the following format: summary(reg)$whatIwant

**Answer:**
The F-statistic is 14.98 which is greater than 10. Since the f_stat is is greater than ten we can say that this is a weak instrument


\pagebreak


## Question:  Regress the following cith characteristics  on the RDI and track length: `area1910` `count1910`, `black1910`, `incseg`, `lfp1920`. Present your results and interpret your findings. Why do these results matter for answering our question of interest?  (2 pages)

Hint 1: In stargazer, add the option `omit.stat=c( "ser")` to remove the residual standard errors from the table footer so that the table fits the width of a page. 

Hint 2: Use the same type of standard errors as the author

**Code and Answer:**
```{r results= 'asis'}
regrdi<- felm(data=maindata, lenper~ area1910 + count1910 + 
                black1910 + incseg + lfp1920)
reglen<- felm(data=maindata, herf~ area1910 + count1910 + 
                black1910 + incseg + lfp1920)
stargazer(regrdi, reglen, type = "latex", header = F, 
          title = "Length and RDI", omit.stat= c("f", "ser"), se = list(regrdi$rse, reglen$rse))
```
These regressions matter because they illustrate the effect each variable has on the outcome variable. Since non of our variables are significant in their effect on the outcome variables we can feel more confident in our case for our instrumental variable.

\pagebreak


## Question: What are the two conditions necessary for a valid instrument? What evidence do you have that the RDI meet these conditions? Be specific in supporting this claim. 

**Answer:**
A valid instrument must meet the following two conditions: 
1)the correlation between the instrument and the explanatory variable must not be zero
2) the correlation between the instrument and all omitted variables must be zero. This second condition is known as the exclusion restriction.

\pagebreak


## Question: Do you believe the instrument is valid? Why/why not?

**Answer:**
We have seen a strong relationship between RDI and dism1990 (segregation). We have also demonstrated an absence of a relationship to potential omitted variables, and, I believe that the absence of a relationship will hold for all omitted variables. for these reasons, RDI is a good instrument.


\pagebreak


## Question: Generate a table that estimates the effect of segregation on the poverty rate for blacks and whites by OLS and then using the RDI instrument. Make sure you report robust standard errors. How does the use of the RDI instrument change the estimated coefficients? 

Hint: these will be the exact results reported in row 2 of columns 1-4 in table 2.

**Code and Answer:**
```{r results= 'asis'}
regivw<-felm(data=maindata, povrate_w ~1|0|(dism1990~herf))
regivb<-felm(data=maindata, povrate_b ~1|0|(dism1990~herf))
stargazer(regw, regb, regivw, regivb, type = "latex", header = F, title = "cComparison", omit.stat= c("f", "ser"), se = list(regw$rse, regb$rse, regivw$rse, regivb$rse) )
```


\pagebreak


## Question: What is the reduced form equation?

**Answer:**
To observe the reduced form, regress outcome variable directly on exogenous instrument. (y = poverty_rate) = B0 + B1(Z = RDI) + error


\pagebreak


## Question: For the two poverty rates, estimate the reduced form on all the cities and illustrate the reduced form relationships graphically. (2 pages)

**Code:**
```{r}
redw <- felm(data = maindata, povrate_w ~ herf)
redb <- felm(data = maindata, povrate_b ~ herf)
```
```{r}
graph1 <- ggplot(data = maindata, aes(x = herf, y = povrate_w)) + geom_smooth(method = "lm") + geom_point() + theme_linedraw()
graph1
graph2 <- ggplot(data = maindata, aes(x=herf, y=povrate_b)) + geom_smooth(method = "lm") + geom_point() + theme_linedraw()
graph2
```

\pagebreak

## Question: Generate a table with six columns that check whether the main results are robust to adding additional controls for city characteristics. What do you conclude? (2 pages)

Hint 1: In stargazer, add the option `omit.stat=c( "ser")` to remove the residual standard errors from the table footer so that the table fits in a page. 

Hint 2: You can choose the controls you want.  


**Code:**
```{r results='asis'}
regr <- felm(data = maindata, povrate_w ~ herf + area1910 + count1910 + black1910 + incseg + lfp1920)
stargazer(regr,  type = "latex", header = F, title = "Comparison", omit.stat= c("f", "ser"), se = list(regr$rse))
```


**Answer:**
Adding city characteristics does not effect outcome because rdi has no effect on omitted variables.

\pagebreak

# Why **Two Stage** least squares? 

Because the estimates in this paper only feature one endogenous regressor and one instrument, it is an excellent example with which to illustrate build intuition and see what the instrumental variables regressor is actually doing because in this scenario the IV estimator is exactly equal to the two stage least squares estimator ($\hat{\beta}_{IV}=\hat{\beta}_{2SLS}$).



## Question: Estimate the first stage regression and use your estimates to generate the predicted values for the explanatory variable for all the observations.

Hint: you can generate a new column in you data the gives you the predicted outcome value for each observation that is generated from a particular regression with code in the format data$newcolumn<-predict(reg_object)

**Code:**
```{r}
regsegrdi <- lm(data = maindata, dism1990 ~ herf + lenper)
maindata$f_stage <- predict(regsegrdi)
```


\pagebreak


## Question: If our instrument is valid, the step above "removed" the "bad" endogenous variation from the predicted explanatory variable, keeping only the exogenous variation that is generated by the instrument. Now run the second stage by regressing our outcome variable on the predicted values generated above and the relevant controls. Compare your estimates from this regression to those generated earlier. How do they compare?

Hint: Use robust standard errors


**Code:**
```{r results='asis'}
regsls<- lm(data = maindata, povrate_w ~ f_stage + lenper)
regslsb<-lm(data = maindata, povrate_b ~ f_stage + lenper)
stargazer(regsls, regslsb, type = "latex", header = F, title = "Comparison", omit.stat= c("f", "ser"), se = list(regsls$rse, regslsb$rse)) 
```


**Answer:**
The long form 2sls coefficient is identical to the coefficient in the IV regression
\pagebreak

# Yet another IV trick: Taking the "Good" variation and scaling it

## Question: Take the coefficient from you reduced form estimate and divide it by your first stage estimate. How does this value compare your earlier estimate for the main result? 

**Answer:**
The process of dividing reduced form B1 by first stage B1 results in B1 hat.

 


\pagebreak



